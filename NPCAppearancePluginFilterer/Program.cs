using System;
using System.Collections.Generic;
using System.Linq;
using Mutagen.Bethesda;
using Mutagen.Bethesda.Synthesis;
using Mutagen.Bethesda.Skyrim;
using System.Threading.Tasks;
using System.IO;
using NPCAppearancePluginFilterer.Settings;

namespace NPCAppearancePluginFilterer
{
    public class Program
    {
        static Lazy<NAPFsettings> Settings = null!;
        public static async Task<int> Main(string[] args)
        {
            return await SynthesisPipeline.Instance
                .SetAutogeneratedSettings(
                    nickname: "Settings",
                    path: "settings.json",
                    out Settings)
                .AddPatch<ISkyrimMod, ISkyrimModGetter>(RunPatch)
                .SetTypicalOpen(GameRelease.SkyrimSE, "YourPatcher.esp")
                .Run(args);
        }

        private static void CanRunPatch(IRunnabilityState state)
        {
            NAPFsettings settings = Settings.Value;
            if (settings.AssetOutputDirectory != "" && !Directory.Exists(settings.AssetOutputDirectory))
            {
                throw new Exception("Cannot find output directory specified in settings: " + settings.AssetOutputDirectory);
            }
        }

        public static void RunPatch(IPatcherState<ISkyrimMod, ISkyrimModGetter> state)
        {
            NAPFsettings settings = Settings.Value;

            HashSet<INpcGetter> FinishedNPCs = new HashSet<INpcGetter>();

            foreach (var PPS in settings.PluginsToForward)
            {
                Console.WriteLine("Processing {0}", PPS.Plugin.ToString());

                foreach (var npc in state.LoadOrder.PriorityOrder.WinningOverrides<INpcGetter>())
                {
                    if (npc.FormKey.ModKey != PPS.Plugin) // THIS IS WRONG. Should be looking at winning override, not root modkey
                    {
                        continue;
                    }

                    string NPCdispStr = npc.Name + " | " + npc.EditorID + " | " + npc.FormKey.ToString();

                    if ((PPS.RemoveTheseNPCs == false && PPS.NPCs.Contains(npc.AsLinkGetter())) || (PPS.RemoveTheseNPCs == true && !PPS.NPCs.Contains(npc.AsLinkGetter())))
                    {
                        Console.WriteLine("Forwarding appearance of {0}", NPCdispStr);
                        var NPCoverride = state.PatchMod.Npcs.GetOrAddAsOverride(npc);
                    }
                }
            }
        }
    }
}
